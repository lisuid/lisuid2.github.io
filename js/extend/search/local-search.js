const $searchMask=document.getElementById("search-mask"),$searchDialog=document.querySelector("#local-search .search-dialog"),$input=document.querySelector("#search-input"),$resultContent=document.getElementById("search-results"),$loadingStatus=document.getElementById("loading-status");let dataObj=null;class search{static openSearch(){utils.fadeIn($searchMask,"0.5"),utils.fadeIn($searchDialog,"0.5"),setTimeout((()=>{document.querySelector("#search-input").focus()}),100),search.search(),document.addEventListener("keydown",(function e(t){"Escape"===t.code&&(closeSearch(),document.removeEventListener("keydown",e))}))}static closeSearch(){utils.fadeOut($searchDialog,"0.5"),utils.fadeOut($searchMask,"0.5")}static async fetchData(e){let t=[];const a=await fetch(e);if(t=[...(await(new window.DOMParser).parseFromString(await a.text(),"text/xml")).querySelectorAll("entry")].map((e=>({title:e.querySelector("title").textContent,content:e.querySelector("content")&&e.querySelector("content").textContent,url:e.querySelector("url").textContent}))),a.ok){const e=document.getElementById("loading-database");e.nextElementSibling.style.display="block",e.remove()}return t}static search(){GLOBAL_CONFIG.localsearch.preload||null!==dataObj||(dataObj=this.fetchData(GLOBAL_CONFIG.localsearch.path)),$input.addEventListener("input",(function(){const e=this.value.trim().toLowerCase().split(/[\s]+/);if(""===e[0])return void($resultContent.innerHTML="");if($loadingStatus.innerHTML='<i class="scoicon sco-loading-line"></i><span>加载中</span>',e.length<=0)return;let t=0,a='<div class="search-result-list">';dataObj.then((c=>{c.forEach((c=>{let s=!0,n=c.title?c.title.trim().toLowerCase():"";const r=c.content?c.content.trim().replace(/<[^>]+>/g,"").toLowerCase():"",l=c.url.startsWith("/")?c.url:GLOBAL_CONFIG.root+c.url;let i=-1,o=-1,d=-1;if(""!==n||""!==r?e.forEach(((e,t)=>{i=n.indexOf(e),o=r.indexOf(e),i<0&&o<0?s=!1:(o<0&&(o=0),0===t&&(d=o))})):s=!1,s){if(d>=0){let c=d-30,s=d+100,i="",o="";c<0&&(c=0),0===c?s=100:i="...",s>r.length?s=r.length:o="...";let h=r.substring(c,s);e.forEach((e=>{const t=new RegExp(`(?!<[^>]*?)(${e})(?![^<]*?>)`,"gi");h=h.replaceAll(t,'<span class="search-keyword">$1</span>'),n=n.replaceAll(t,'<span class="search-keyword">$1</span>')})),a+='<div class="search__hit-item"><a href="'+l+'"><span class="search-result-title">'+n+"</span>",t+=1,""!==r&&(a+='<div class="search-result">'+i+h+o+"</div>")}a+="</a></div>"}})),a+=0===t?`<div id="search__hits-empty">${GLOBAL_CONFIG.lang.search.empty}</div>`:`<div class="search__hits-count">${GLOBAL_CONFIG.lang.search.hit.replace("${query}",'<span class="search-keyword">'+t+"</span>")}</div>`,a+="</div>",$resultContent.innerHTML=a,""!==e[0]&&($loadingStatus.innerHTML="")}))}))}}const searchClickFn=()=>{"404"!==PAGE_CONFIG.page&&document.querySelector("#search-button > .search").addEventListener("click",search.openSearch),GLOBAL_CONFIG.rightmenu.enable&&document.getElementById("menu-search").addEventListener("click",(function(){rm.hideRightMenu(),search.openSearch();let e=document.getElementsByClassName("search-box-input")[0],t=new Event("input",{bubbles:!0,cancelable:!0});e.value=selectTextNow,e.dispatchEvent(t)}))},searchClickFnOnce=()=>{document.querySelector("#local-search .search-close-button").addEventListener("click",search.closeSearch),$searchMask.addEventListener("click",search.closeSearch),GLOBAL_CONFIG.localsearch.preload&&(dataObj=search.fetchData(GLOBAL_CONFIG.localsearch.path))};window.addEventListener("load",(()=>{searchClickFn(),searchClickFnOnce()})),window.addEventListener("pjax:complete",(()=>{searchClickFn()}));